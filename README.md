# ゼンレスゾーンゼロ サブステ最適化ツール

## 概要

ゼンレスゾーンゼロにおけるダメージを最大化するための、サブステの最適な分配を発見する事を目的としたGAS。

スプレッドシートのダメージ計算と連携し、膨大なサブステ配分パターンを自動評価して理論上最適なのダメージを実現するサブステ配分を発見することが目的。


## アルゴリズムが解決するべき問題

* **組み合わせ爆発**
  * 全10種のサブステの全ヒットパターンは膨大な数となる
* **非線形関係**
  * サブステ間の相互作用やサブステの効用が非線形である事により、直感的な配分が最適解にならない可能性がある
* **時間制約**
  * 手動での全パターン検証は現実的に不可能。
  * ダメージ計算をスプレッドシートに委譲するため、スプレッドシートの更新が全体のボトルネックとなる。

## やらないこと

- ゼンレスゾーンゼロのダメージ計算式の知識をアルゴリズム内に組み込まない
- 実用性の観点で過剰とも言える最適化

## アルゴリズム戦略

### 全体戦略: 段階的最適化アプローチ

 **「粗い配分で大まかな解を見つけてから、細かく調整する」** という段階的戦略を採用。

この設計により、計算時間を大幅に削減しながら高精度な最適解を発見することを目的にしている。

### 各段階の役割分担

**Phase1（荒い配分による最適化）**: 全体の80-90%の改善を短時間で実現
- 指定されたヒット数を一定サイズのバッチに分けて、以下のプロセスで段階的に割り当てる
  - 各サブステ1ヒット当たりのダメージ上昇率を測定
  - 測定結果の上位のステータスに対して上昇率の比率に応じて割当を行う

**Phase2（リバランスによる精緻化）**: 残り10-20%の改善を丁寧に探索
- 配分済みのヒット数の組み合わせを基準に、より良い配分を局所探索で求める
- 各サブステのダメージ上昇率の記録を元に、効率的なペアを優先的に試す
- 局所探索の過程で落第したステータスについて、最終フェーズで効率性の再評価を行う

### Phase1

```
処理手順:
1. 各サブステ +1ヒット時のダメージ増加量(効用)を測定
2. 効果が高い上位3つのサブステを特定  
3. 効果の比率に応じて10ヒットずつ配分
4. 全ヒット数を配分するまで1-3を繰り返し
```

#### 設計の観点
- **バッチ処理**
  - 計算コストと精度のバランス最適化のために、一定サイズのバッチでまとめて割当を行う
  - 初期段階のバッチサイズを大きく、後半のサイズを小さくするなどするとより精度が上がるが今は効率性を重視してバッチサイズを10としている
- **上位ステータスの選択敵配分**
  - 全10変数を毎回評価すると組み合わせ爆発、上位1つだけでは多様性不足。
  - バッチ処理の初期段階に各ステータスの効用を確認し、上位3つのステータスに分配することで、探索範囲と効率の両立を目指す
- **比例配分**
  - 最高効用変数への集中配分ではなく、効用比に応じた分散配分により初期段階での局所最適を回避

### Phase2

```
処理手順:
局所最適化:
1. 配分済みサブステ間でヒット数を1つずつ移動
2. ダメージ上昇率の効用差(移動先効用 - 移動元効用)で候補をソート
3. 上位10候補を実際に評価し、改善があれば採用
4. 改善がなくなるまで最大30回繰り返し

未使用サブステの再評価:
1. ヒット数0のサブステの内もっとも優秀なステータスと配分済みサブステの全ペアを評価
2. ダメージ上昇効用が改善された場合、そのステータスを採用する
```

#### 設計の観点
- **適応的効用調整**
  - 移動履歴を効用値に反映し、同一パターンの無限ループを防止。探索の多様性を確保
- **閾値ベース収束**
  - 微小改善での無限探索を防止。計算コストと精度の実用的バランス
- **ゼロヒット再評価**
  - 局所探索では発見不可能な大域最適解への配慮。初期段階で除外された変数の潜在価値を再評価
  - 本来はゼロヒットで再評価されたものが採用された場合、更に局所探査を繰り返す方が理想だが、効率性の観点でそこはスキップ

## 技術仕様

- **動作環境**: Google Apps Script + Google Sheets
- **最適化手法**: 2段階ハイブリッド最適化
  - Phase1: Batch Greedy Algorithm（効用ベースの貪欲法）
  - Phase2: Hill Climbing + Zero-Hit Swap（局所探索 + 大域探索要素）
  - 収束制御: 適応的効用調整 + 閾値ベース停止条件
- **計算方式**: スプレッドシート連携によるブラックボックス最適化
  - 目的関数評価: Google Sheets計算エンジン
  - 制約処理: 整数制約 + 総和制約の組み込み処理

## 適用範囲

- ゼンレスゾーンゼロのサブステ最適化
- 類似するリソース配分問題
- スプレッドシート計算を伴う数値最適化